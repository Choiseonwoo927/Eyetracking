<!DOCTYPE html>
<html>

<head>
    <title>그림-글자 쌍 기억 실험</title>
    <script src="https://webgazer.cs.brown.edu/webgazer.js" type="text/javascript"></script>
    <style>
        body {
            text-align: center;
        }

        #stimulus-container {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: flex;
            justify-content: center;
            align-items: center;
            width: 800px;
            height: 600px;
        }

        #message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        #consent-area {
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            text-align: left;
        }

        #consent-text {
            border: 1px solid #ccc;
            padding: 15px;
            margin-bottom: 20px;
        }

        #consent-area label {
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1.1em;
            margin-top: 20px;
        }
    </style>
</head>

<body>
    <div id="message">
        <p> 안녕하세요. 가천대학교 심리학과 최선우, 이지흠 외 4인입니다. </p>

        <p> 위 실험은 제4회 가천대학교 심리학과 학술제에서 그림-글자 자극의 배치와 일치성이 시각작업기억에 미치는 영향을 실험하고자 합니다. </p>

        <p> 실험을 시작하려면 '시작하기'를 클릭하세요. </p>
        <button onclick="startExperiment()">시작하기</button>
    </div>

    <script>
        let allStimuli = [];
        let experimentData = [];
        let currentTrialGazeData = [];
        let trialStartTime = 0;
        let responseHandler = null;

        const SPREADSHEET_URL = 'https://script.google.com/macros/s/AKfycbwuwNsk6BrLoGslQRQpFrutmbozG-YpEbbgtYzoho8blXHoqbqd9EPuOS3cNhIQ7IoV/exec';
        const stimuli_json_url = 'https://Choiseonwoo927.github.io/Eyetracking/conditions/total_cond.json';

        function shuffle(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        async function loadStimuli() {
            try {
                const response = await fetch(stimuli_json_url);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();

                allStimuli = shuffle(
                    data.congruent.map(url => ({ url, congruency: 'congruent' }))
                        .concat(
                            data.incongruent.map(url => ({ url, congruency: 'incongruent' })),
                            data.congruent_same.map(url => ({ url, congruency: 'congruent_same' })),
                            data.incongruent_same.map(url => ({ url, congruency: 'incongruent_same' }))
                        )
                );
            } catch (error) {
                console.error('자극 파일을 불러오는 데 실패했습니다:', error);
                document.getElementById('message').innerHTML = '<p style="color:red;">자극 파일을 불러오는 데 문제가 있습니다. GitHub Pages URL을 확인하세요.</p>';
            }
        }

        let currentTrialIndex = 0;
        function showNextTrial() {
            if (currentTrialIndex < allStimuli.length) {
                const currentStim = allStimuli[currentTrialIndex];
                const messageDiv = document.getElementById('message');

                // 첫 번째 시행에만 지시문을 보여줍니다.
                if (currentTrialIndex === 0) {
                    messageDiv.innerHTML = `<p>그림과 글자가 일치하면 'z'키를, 불일치하면 '/'키를 눌러주세요. (키보드의 z, / 키로 반응)</p>`;
                    messageDiv.style.display = 'block';

                    setTimeout(() => {
                        messageDiv.style.display = 'none';
                        displayStimulus(currentStim);
                    }, 5000); // 5초 후 자극 제시
                } else {
                    // 첫 번째 시행 이후에는 바로 자극을 제시합니다.
                    displayStimulus(currentStim);
                }
            } else {
                endExperiment();
            }
        }

        function displayStimulus(stimulus) {
            let stimulusContainer = document.getElementById('stimulus-container');
            if (!stimulusContainer) {
                stimulusContainer = document.createElement('div');
                stimulusContainer.id = 'stimulus-container';
                document.body.appendChild(stimulusContainer);
            }

            stimulusContainer.innerHTML = '';

            const img = document.createElement('img');
            img.src = stimulus.url;
            img.style.maxWidth = '800px';
            img.style.maxHeight = '600px';
            stimulusContainer.appendChild(img);

            currentTrialGazeData = [];
            trialStartTime = performance.now();

            responseHandler = function (event) {
                if (event.key === 'z' || event.key === '/') {
                    const reactionTime = performance.now() - trialStartTime;

                    stimulusContainer.innerHTML = '';

                    experimentData.push({
                        trial_index: currentTrialIndex,
                        stimulus_url: stimulus.url,
                        congruency: stimulus.congruency,
                        response: event.key,
                        reaction_time: reactionTime,
                        gaze_data: currentTrialGazeData
                    });

                    window.removeEventListener('keydown', responseHandler);
                    currentTrialIndex++;
                    showNextTrial();
                }
            };
            window.addEventListener('keydown', responseHandler);
        }

        async function startExperiment() {
            const messageDiv = document.getElementById('message');
            messageDiv.innerHTML = `
                <div id="consent-area">
                    <div id="consent-text">
                        <p style="text-align: center; font-size: 1.2em; font-weight: bold;">개인정보 수집 및 이용 동의</p>
                        <p>본 실험은 참가자의 시선 데이터를 수집합니다. 수집된 데이터는 연구 목적으로만 활용되며, 개인을 식별할 수 있는 정보는 포함되지 않습니다. 수집된 데이터는 안전하게 보관되며, 연구 종료 후 파기됩니다.</p>
                        <p>실험 참여에 동의하십니까? (실험 담당자: 가천대학교 심리학과 최선우, 010-7462-3224)</p>
                    </div>
                    <label for="consent-checkbox">
                        <input type="checkbox" id="consent-checkbox" style="margin-right: 10px;"> 개인정보 수집 및 이용에 동의합니다.
                    </label>
                </div>
                <button onclick="checkConsent()" style="margin-top: 20px;">동의하고 계속하기</button>
            `;
        }

        async function checkConsent() {
            const consentCheckbox = document.getElementById('consent-checkbox');
            if (consentCheckbox.checked) {
                continueExperiment();
            } else {
                alert('실험 참여를 위해 개인정보 수집 및 이용에 동의해야 합니다.');
            }
        }

        async function continueExperiment() {
            const messageDiv = document.getElementById('message');
            messageDiv.innerHTML = '<p>웹캠 접근을 허용해주세요...</p>';

            webgazer.setGazeListener(function (data, elapsedTime) {
                if (data == null) return;
                currentTrialGazeData.push({
                    x: data.x,
                    y: data.y,
                    time: elapsedTime
                });
            });

            await webgazer.begin();
            webgazer.showPredictionPoints(false);

            messageDiv.innerHTML = '<p>자극 파일을 불러오는 중...</p>';
            await loadStimuli();

            if (allStimuli.length === 0) {
                messageDiv.innerHTML = '<p style="color:red;">자극 파일을 불러오는 데 문제가 있습니다. GitHub Pages URL을 확인하세요.</p>';
                return;
            }

            messageDiv.innerHTML = '<p>실험이 곧 시작됩니다...</p>';
            setTimeout(() => {
                messageDiv.style.display = 'none';
                showNextTrial();
            }, 2000);
        }

        function endExperiment() {
            const stimulusContainer = document.getElementById('stimulus-container');
            if (stimulusContainer) {
                stimulusContainer.remove();
            }

            const messageDiv = document.getElementById('message');
            messageDiv.style.display = 'block';
            messageDiv.innerHTML = '<p>실험이 모두 끝났습니다. 데이터를 저장하는 중...</p>';

            fetch(SPREADSHEET_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'text/plain' },
                body: JSON.stringify(experimentData)
            })
                .then(response => response.json())
                .then(data => {
                    if (data.result === 'success') {
                        messageDiv.innerHTML = `
                        <p style="color: green;"> 데이터가 성공적으로 저장되었습니다! </p>
                        <p style="size: 1.2em;"> 참여해주셔서 감사합니다. </p>`;
                    } else {
                        messageDiv.innerHTML = '<p style="color: red;">데이터 저장에 실패했습니다. 실험 담당자에게 연락 바랍니다.</p>';
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    messageDiv.innerHTML = '<p style="color: red;">데이터 전송 중 오류가 발생했습니다. 실험 담당자에게 연락 바랍니다.</p>';
                });
        }
    </script>
</body>

</html>